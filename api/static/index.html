<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Manager - SQL Console</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üóÑÔ∏è</text></svg>">
    <style>
        :root {
            --primary-bg: #1e1e1e;
            --secondary-bg: #252526;
            --tertiary-bg: #2d2d30;
            --hover-bg: #37373d;
            --border-color: #3e3e42;
            --text-primary: #cccccc;
            --text-secondary: #969696;
            --accent-blue: #007acc;
            --accent-green: #4ec9b0;
            --accent-orange: #ce9178;
            --accent-red: #f48771;
            --accent-yellow: #dcdcaa;
            --sidebar-width: 280px;
            --header-height: 50px;
            --statusbar-height: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .app-header {
            height: var(--header-height);
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            position: relative;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo {
            font-size: 24px;
        }

        .app-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            background: var(--tertiary-bg);
            border-radius: 4px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: calc(100vh - var(--header-height) - var(--statusbar-height));
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--secondary-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 12px 16px;
            background: var(--tertiary-bg);
            border-bottom: 1px solid var(--border-color);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 8px 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .database-tree {
            list-style: none;
        }

        .tree-item {
            padding: 6px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
        }

        .tree-item:hover {
            background: var(--hover-bg);
        }

        .tree-item.active {
            background: var(--accent-blue);
            color: white;
        }

        .tree-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
        }

        /* Upload Zone */
        .upload-zone {
            margin: 12px;
            padding: 24px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--tertiary-bg);
        }

        .upload-zone:hover {
            border-color: var(--accent-blue);
            background: var(--hover-bg);
        }

        .upload-zone.drag-over {
            border-color: var(--accent-green);
            background: rgba(78, 201, 176, 0.1);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .upload-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .upload-text strong {
            color: var(--text-primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tabs */
        .tabs-container {
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: flex-end;
            padding: 0 8px;
            min-height: 35px;
        }

        .tab {
            padding: 6px 16px;
            background: var(--tertiary-bg);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 2px;
            transition: background 0.15s;
        }

        .tab:hover {
            background: var(--hover-bg);
        }

        .tab.active {
            background: var(--primary-bg);
            border-bottom: 2px solid var(--accent-blue);
        }

        /* Editor Area */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-toolbar {
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 12px;
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            background: var(--tertiary-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .toolbar-btn:hover {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
        }

        .toolbar-btn.primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            font-weight: 500;
        }

        .toolbar-btn.primary:hover {
            background: #006bb3;
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* SQL Editor */
        .sql-editor {
            flex: 1;
            position: relative;
            background: var(--primary-bg);
        }

        #sqlTextarea {
            width: 100%;
            height: 100%;
            background: var(--primary-bg);
            color: var(--text-primary);
            border: none;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        /* Results Panel */
        .results-panel {
            height: 50%;
            background: var(--primary-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .results-header {
            background: var(--secondary-bg);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .results-info {
            color: var(--text-secondary);
        }

        .results-content {
            flex: 1;
            overflow: auto;
            padding: 16px;
        }

        /* Table View */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: var(--secondary-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .data-table th {
            background: var(--tertiary-bg);
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tr:hover {
            background: var(--hover-bg);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message-icon {
            font-size: 18px;
            margin-top: 2px;
        }

        .message-content {
            flex: 1;
        }

        .message.success {
            background: rgba(78, 201, 176, 0.15);
            border-left: 3px solid var(--accent-green);
        }

        .message.error {
            background: rgba(244, 135, 113, 0.15);
            border-left: 3px solid var(--accent-red);
        }

        .message.info {
            background: rgba(0, 122, 204, 0.15);
            border-left: 3px solid var(--accent-blue);
        }

        .message.warning {
            background: rgba(220, 220, 170, 0.15);
            border-left: 3px solid var(--accent-yellow);
        }

        /* Status Bar */
        .status-bar {
            height: var(--statusbar-height);
            background: var(--accent-blue);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 11px;
            color: white;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--tertiary-bg);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--hover-bg);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Splitter */
        .splitter {
            height: 4px;
            background: var(--secondary-bg);
            cursor: ns-resize;
            position: relative;
        }

        .splitter:hover {
            background: var(--accent-blue);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 6px 24px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background: var(--hover-bg);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--tertiary-bg);
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .badge.primary {
            background: var(--accent-blue);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            :root {
                --sidebar-width: 0;
            }
        }

        /* Table Schema View */
        .schema-table {
            margin: 12px 0;
            background: var(--secondary-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .schema-header {
            padding: 10px 12px;
            background: var(--tertiary-bg);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .schema-body {
            padding: 8px;
        }

        .schema-column {
            padding: 6px 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 3px;
        }

        .schema-column:hover {
            background: var(--hover-bg);
        }

        .column-icon {
            color: var(--accent-yellow);
        }

        .column-name {
            flex: 1;
            font-family: 'Consolas', monospace;
        }

        .column-type {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .column-badge {
            font-size: 9px;
            padding: 2px 4px;
        }

        /* Quick Actions Panel */
        .quick-actions {
            margin: 12px;
            background: var(--tertiary-bg);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .quick-actions-header {
            padding: 8px 12px;
            background: var(--secondary-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.15s;
        }

        .quick-actions-header:hover {
            background: var(--hover-bg);
        }

        .quick-actions-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-actions-toggle {
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .quick-actions-toggle.expanded {
            transform: rotate(180deg);
        }

        .quick-actions-content {
            max-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease;
        }

        .quick-actions-content.expanded {
            max-height: 600px;
        }

        .quick-action-item {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.15s;
        }

        .quick-action-item:last-child {
            border-bottom: none;
        }

        .quick-action-item:hover {
            background: var(--hover-bg);
        }

        .quick-action-step {
            font-size: 10px;
            color: var(--accent-blue);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .quick-action-title {
            font-size: 12px;
            color: var(--text-primary);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-action-desc {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .quick-action-item.completed {
            opacity: 0.6;
        }

        .quick-action-item.completed .quick-action-step {
            color: var(--accent-green);
        }

        .quick-action-item.active {
            background: rgba(0, 122, 204, 0.1);
            border-left: 3px solid var(--accent-blue);
        }

        .workflow-progress {
            padding: 8px 12px;
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            font-size: 10px;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-blue);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Performance Stats Panel */
        .perf-stats {
            margin: 12px;
            background: var(--tertiary-bg);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .perf-stats-header {
            padding: 8px 12px;
            background: var(--secondary-bg);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .perf-stats-body {
            padding: 12px;
        }

        .perf-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            background: var(--secondary-bg);
            border-radius: 4px;
            font-size: 12px;
        }

        .perf-stat-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .perf-stat-value {
            font-weight: 600;
            color: var(--accent-green);
        }

        .perf-badge {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(78, 201, 176, 0.2);
            border-radius: 3px;
            font-size: 10px;
            color: var(--accent-green);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="app-header">
        <div class="header-left">
            <div class="app-logo">üóÑÔ∏è</div>
            <div class="app-title">Database Manager</div>
        </div>
        <div class="header-right">
            <div class="connection-status">
                <div class="status-dot"></div>
                <span id="connectionStatus">Conectado</span>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span>üóÉÔ∏è Base de Datos</span>
                <button class="toolbar-btn" onclick="refreshTables()" style="padding: 2px 6px; font-size: 10px;">
                    üîÑ
                </button>
            </div>
            <div class="sidebar-content">
                <!-- Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">
                        <strong>Arrastra un archivo CSV aqu√≠</strong><br>
                        o haz click para seleccionar
                    </div>
                    <input type="file" id="fileInput" accept=".csv" style="display: none;">
                </div>

                <!-- Quick Actions / Workflow Guide -->
                <div class="quick-actions">
                    <div class="quick-actions-header" onclick="toggleQuickActions()">
                        <div class="quick-actions-title">
                            <span>‚ö°</span>
                            <span>Flujo R√°pido</span>
                        </div>
                        <span class="quick-actions-toggle" id="quickActionsToggle">‚ñº</span>
                    </div>
                    <div class="quick-actions-content" id="quickActionsContent">
                        <div class="workflow-progress">
                            <span>Pipeline Completo: <span id="workflowPercent">0</span>%</span>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="quick-action-item" onclick="runWorkflowStep(1)" id="step1">
                            <div class="quick-action-step">PASO 1/10 ‚Ä¢ Sequential</div>
                            <div class="quick-action-title">
                                <span>üìù</span>
                                <strong>Crear Tabla Empleados</strong>
                            </div>
                            <div class="quick-action-desc">Sequential File para b√∫squedas ordenadas</div>
                        </div>
                        <div class="quick-action-item" onclick="runWorkflowStep(2)" id="step2">
                            <div class="quick-action-step">PASO 2/10 ‚Ä¢ Sequential</div>
                            <div class="quick-action-title">
                                <span>‚ûï</span>
                                <strong>Insertar 15 Empleados</strong>
                            </div>
                            <div class="quick-action-desc">Carga masiva de registros en Sequential</div>
                        </div>
                        <div class="quick-action-item" onclick="runWorkflowStep(3)" id="step3">
                            <div class="quick-action-step">PASO 3/10 ‚Ä¢ Sequential</div>
                            <div class="quick-action-title">
                                <span>üìä</span>
                                <strong>B√∫squeda por Rango</strong>
                            </div>
                            <div class="quick-action-desc">BETWEEN - Consulta eficiente de rango</div>
                        </div>
                        <div class="quick-action-item" onclick="runWorkflowStep(4)" id="step4">
                            <div class="quick-action-step">PASO 4/10 ‚Ä¢ B+Tree</div>
                            <div class="quick-action-title">
                                <span>üå≥</span>
                                <strong>Crear Tabla Productos</strong>
                            </div>
                            <div class="quick-action-desc">B+Tree para b√∫squedas logar√≠tmicas</div>
                        </div>
                        <div class="quick-action-item" onclick="runWorkflowStep(5)" id="step5">
                            <div class="quick-action-step">PASO 5/10 ‚Ä¢ B+Tree</div>
                            <div class="quick-action-title">
                                <span>ÔøΩ</span>
                                <strong>Cargar 15 Productos</strong>
                            </div>
                            <div class="quick-action-desc">Inserci√≥n en √°rbol balanceado</div>
                        </div>
                        <div class="quick-action-item" onclick="runWorkflowStep(6)" id="step6">
                            <div class="quick-action-step">PASO 6/10 ‚Ä¢ B+Tree</div>
                            <div class="quick-action-title">
                                <span>üéØ</span>
                                <strong>B√∫squeda Exacta</strong>
                            </div>
                            <div class="quick-action-desc">SELECT con O(log n) en B+Tree</div>
                        </div>
                        <div class="quick-action-item" onclick="runWorkflowStep(7)" id="step7">
                            <div class="quick-action-step">PASO 7/10 ‚Ä¢ Hash</div>
                            <div class="quick-action-title">
                                <span>#Ô∏è‚É£</span>
                                <strong>Crear Tabla Clientes</strong>
                            </div>
                            <div class="quick-action-desc">Extendible Hashing para acceso O(1)</div>
                        </div>
                        <div class="quick-action-item" onclick="runWorkflowStep(8)" id="step8">
                            <div class="quick-action-step">PASO 8/10 ‚Ä¢ Hash</div>
                            <div class="quick-action-title">
                                <span>ÔøΩ</span>
                                <strong>Registrar 10 Clientes</strong>
                            </div>
                            <div class="quick-action-desc">Distribuci√≥n por funci√≥n hash</div>
                        </div>
                        <div class="quick-action-item" onclick="runWorkflowStep(9)" id="step9">
                            <div class="quick-action-step">PASO 9/10 ‚Ä¢ Hash</div>
                            <div class="quick-action-title">
                                <span>‚ö°</span>
                                <strong>B√∫squeda Instant√°nea</strong>
                            </div>
                            <div class="quick-action-desc">Acceso directo O(1) por DNI</div>
                        </div>
                        <div class="quick-action-item" onclick="runWorkflowStep(10)" id="step10">
                            <div class="quick-action-step">PASO 10/10 ‚Ä¢ Multi-Query</div>
                            <div class="quick-action-title">
                                <span>üéØ</span>
                                <strong>An√°lisis Final</strong>
                            </div>
                            <div class="quick-action-desc">Consultas complejas y limpieza</div>
                        </div>
                    </div>
                </div>

                <!-- Last Query Execution -->
                <div class="perf-stats" id="perfStats" style="display: none;">
                    <div class="perf-stats-header">
                        <span>‚è±Ô∏è</span>
                        <span>√öltima Ejecuci√≥n</span>
                    </div>
                    <div class="perf-stats-body" id="lastQueryInfo">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>

                <!-- Tables Section -->
                <div class="section-title">
                    <span>üìä</span>
                    <span>TABLAS (<span id="tablesCount">0</span>)</span>
                </div>
                <ul class="database-tree" id="tablesList">
                    <li class="empty-state-text" style="padding: 12px; font-size: 12px;">
                        No hay tablas creadas
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tab active" id="queryTab">
                    <span>üîç</span>
                    <span>SQL Console</span>
                </div>
            </div>

            <!-- Editor -->
            <div class="editor-container">
                <div class="editor-toolbar">
                    <button class="toolbar-btn primary" onclick="executeQuery()" id="executeBtn">
                        <span>‚ñ∂Ô∏è</span>
                        <span>Ejecutar</span>
                    </button>
                    <button class="toolbar-btn" onclick="clearEditor()">
                        <span>üóëÔ∏è</span>
                        <span>Limpiar</span>
                    </button>
                    <button class="toolbar-btn" onclick="formatSQL()">
                        <span>‚ú®</span>
                        <span>Formatear</span>
                    </button>
                    <div style="flex: 1;"></div>
                    <span class="badge" id="lineCount">L√≠nea 1, Columna 1</span>
                </div>

                <div class="sql-editor">
                    <textarea
                        id="sqlTextarea"
                        placeholder="-- Escribe tu consulta SQL aqu√≠&#10;-- Ejemplos:&#10;-- CREATE TABLE Productos (id INT KEY INDEX SEQ, nombre VARCHAR[100], precio FLOAT);&#10;-- INSERT INTO Productos VALUES (1, &quot;Laptop&quot;, 999.99);&#10;-- SELECT * FROM Productos;&#10;&#10;-- Presiona Ctrl+Enter para ejecutar"
                        spellcheck="false"
                    ></textarea>
                </div>

                <div class="splitter" id="splitter"></div>

                <div class="results-panel" id="resultsPanel">
                    <div class="results-header">
                        <div>
                            <strong>üìã Resultados</strong>
                            <span class="results-info" id="resultsInfo"></span>
                        </div>
                        <div>
                            <span class="badge" id="executionTime"></span>
                        </div>
                    </div>
                    <div class="results-content" id="resultsContent">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-text">
                                Ejecuta una consulta para ver los resultados
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <span>‚ö°</span>
            <span id="statusMessage">Listo</span>
        </div>
        <div class="status-item">
            <span id="tableCount">0 tablas</span>
            <span>|</span>
            <span id="serverUptime">Activo</span>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="viewTableData()">
            <span>üëÅÔ∏è</span>
            <span>Ver datos</span>
        </div>
        <div class="context-menu-item" onclick="viewTableSchema()">
            <span>üìê</span>
            <span>Ver estructura</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="generateSelect()">
            <span>üîç</span>
            <span>Generar SELECT</span>
        </div>
        <div class="context-menu-item" onclick="generateInsert()">
            <span>‚ûï</span>
            <span>Generar INSERT</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="dropTable()">
            <span>üóëÔ∏è</span>
            <span>Eliminar tabla</span>
        </div>
    </div>

    <script>
        // Global State
        const state = {
            tables: [],
            currentTable: null,
            isExecuting: false,
            API_BASE: '/api'
        };

        // SQL Keywords for syntax highlighting
        const SQL_KEYWORDS = ['SELECT', 'FROM', 'WHERE', 'INSERT', 'INTO', 'VALUES', 'CREATE', 'TABLE',
                              'DELETE', 'UPDATE', 'SET', 'INDEX', 'KEY', 'INT', 'VARCHAR', 'FLOAT',
                              'ARRAY', 'AND', 'OR', 'BETWEEN', 'IN', 'LIKE', 'ORDER', 'BY', 'GROUP'];

        // Initialize App
        document.addEventListener('DOMContentLoaded', async () => {
            await initApp();
            setupEventListeners();
            setupDragAndDrop();
            setupSplitter();
            updateLineCount();
        });

        async function initApp() {
            updateStatus('Inicializando aplicaci√≥n...', 'info');
            await checkServerStatus();
            await loadTables();
            updateStatus('Listo', 'success');

            // Mostrar un mensaje sutil sobre el flujo r√°pido
            setTimeout(() => {
                updateStatus('üí° Tip: Usa el panel "‚ö° Flujo R√°pido" para ver un pipeline completo', 'info');
            }, 3000);
        }

        function setupEventListeners() {
            const textarea = document.getElementById('sqlTextarea');

            // Keyboard shortcuts
            textarea.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    executeQuery();
                }

                // Tab support
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    textarea.value = textarea.value.substring(0, start) + '    ' + textarea.value.substring(end);
                    textarea.selectionStart = textarea.selectionEnd = start + 4;
                }
            });

            // Update line count
            textarea.addEventListener('keyup', updateLineCount);
            textarea.addEventListener('click', updateLineCount);

            // File input
            const fileInput = document.getElementById('fileInput');
            const uploadZone = document.getElementById('uploadZone');

            uploadZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);

            // Context menu
            document.addEventListener('click', () => {
                document.getElementById('contextMenu').classList.remove('show');
            });
        }

        function setupDragAndDrop() {
            const uploadZone = document.getElementById('uploadZone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => {
                    uploadZone.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => {
                    uploadZone.classList.remove('drag-over');
                }, false);
            });

            uploadZone.addEventListener('drop', handleDrop, false);
        }

        function setupSplitter() {
            const splitter = document.getElementById('splitter');
            const resultsPanel = document.getElementById('resultsPanel');
            let isResizing = false;

            splitter.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'ns-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerHeight = document.querySelector('.editor-container').clientHeight;
                const newHeight = containerHeight - e.clientY + document.querySelector('.editor-container').offsetTop;

                if (newHeight > 100 && newHeight < containerHeight - 100) {
                    resultsPanel.style.height = newHeight + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });
        }

        function updateLineCount() {
            const textarea = document.getElementById('sqlTextarea');
            const text = textarea.value.substring(0, textarea.selectionStart);
            const line = text.split('\n').length;
            const col = text.split('\n').pop().length + 1;
            document.getElementById('lineCount').textContent = `L√≠nea ${line}, Columna ${col}`;
        }

        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                await uploadCSV(file);
            }
        }

        async function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                await uploadCSV(files[0]);
            }
        }

        async function uploadCSV(file) {
            if (!file.name.endsWith('.csv')) {
                showMessage('error', 'Error', 'Por favor selecciona un archivo CSV v√°lido');
                return;
            }

            updateStatus('Cargando archivo CSV...', 'info');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${state.API_BASE}/upload-csv`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('success', '‚úÖ Archivo cargado exitosamente',
                        `Tabla "${result.table_name}" creada con ${result.rows_inserted} de ${result.rows_processed} filas`);

                    await loadTables();
                    updateStatus('Archivo CSV cargado exitosamente', 'success');

                    // Show the CREATE TABLE statement
                    const textarea = document.getElementById('sqlTextarea');
                    textarea.value = result.create_table_sql + '\n\n-- ' + result.rows_inserted + ' filas insertadas';
                } else {
                    showMessage('error', '‚ùå Error al cargar CSV', result.detail || 'Error desconocido');
                    updateStatus('Error cargando CSV', 'error');
                }
            } catch (error) {
                showMessage('error', '‚ùå Error de conexi√≥n', error.message);
                updateStatus('Error de conexi√≥n', 'error');
            }

            // Reset file input
            document.getElementById('fileInput').value = '';
        }

        async function checkServerStatus() {
            try {
                const response = await fetch(`${state.API_BASE}/status`);
                const status = await response.json();
                document.getElementById('connectionStatus').textContent = 'Conectado';
                document.getElementById('serverUptime').textContent = `Activo ${Math.floor(status.uptime_seconds)}s`;
            } catch (error) {
                document.getElementById('connectionStatus').textContent = 'Desconectado';
                showMessage('error', '‚ö†Ô∏è Servidor desconectado', 'No se pudo conectar con el servidor');
            }
        }

        async function loadTables() {
            try {
                const response = await fetch(`${state.API_BASE}/tables`);
                state.tables = await response.json();

                const tablesList = document.getElementById('tablesList');
                const tablesCount = document.getElementById('tablesCount');
                const tableCount = document.getElementById('tableCount');

                tablesCount.textContent = state.tables.length;
                tableCount.textContent = `${state.tables.length} tabla${state.tables.length !== 1 ? 's' : ''}`;

                if (state.tables.length === 0) {
                    tablesList.innerHTML = '<li class="empty-state-text" style="padding: 12px; font-size: 12px;">No hay tablas creadas</li>';
                } else {
                    tablesList.innerHTML = state.tables.map(table => `
                        <li class="tree-item" onclick="selectTable('${table}')" oncontextmenu="showContextMenu(event, '${table}')">
                            <span class="tree-icon">üìã</span>
                            <span>${table}</span>
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading tables:', error);
            }
        }

        function selectTable(tableName) {
            state.currentTable = tableName;

            // Update active state
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Mostrar datos de la tabla al hacer clic
            viewTableData();
        }

        function showContextMenu(event, tableName) {
            event.preventDefault();
            state.currentTable = tableName;

            const menu = document.getElementById('contextMenu');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('show');
        }

        async function executeQuery() {
            const textarea = document.getElementById('sqlTextarea');
            const sql = textarea.value.trim();

            if (!sql) {
                showMessage('warning', '‚ö†Ô∏è Advertencia', 'Por favor ingresa una consulta SQL');
                return;
            }

            if (state.isExecuting) {
                showMessage('warning', '‚è≥ Espera', 'Ya se est√° ejecutando una consulta');
                return;
            }

            // Validaci√≥n b√°sica en el cliente
            if (sql.length > 10000) {
                showMessage('error', '‚ùå Error', 'La consulta es demasiado larga (m√°ximo 10,000 caracteres)');
                return;
            }

            // Verificar que tenga punto y coma al final (advertencia suave)
            if (!sql.endsWith(';')) {
                const addSemicolon = confirm('La consulta no termina con punto y coma (;). ¬øDeseas agregarlo autom√°ticamente?');
                if (addSemicolon) {
                    textarea.value = sql + ';';
                } else {
                    showMessage('warning', '‚ö†Ô∏è Advertencia', 'Se recomienda terminar las consultas SQL con punto y coma (;)');
                }
            }

            setExecuting(true);
            updateStatus('Ejecutando consulta...', 'info');

            try {
                const response = await fetch(`${state.API_BASE}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql, should_validate: true })
                });

                const result = await response.json();
                displayResults(result);

                if (result.success) {
                    updateStatus(`Consulta ejecutada exitosamente (${result.execution_time_ms.toFixed(2)}ms)`, 'success');
                    await loadTables();

                    // Determinar tipo de query
                    const sqlUpper = sql.toUpperCase().trim();
                    let queryType = 'OTHER';
                    if (sqlUpper.startsWith('SELECT')) queryType = 'SELECT';
                    else if (sqlUpper.startsWith('INSERT')) queryType = 'INSERT';
                    else if (sqlUpper.startsWith('CREATE')) queryType = 'CREATE';
                    else if (sqlUpper.startsWith('DELETE')) queryType = 'DELETE';
                    else if (sqlUpper.startsWith('UPDATE')) queryType = 'UPDATE';

                    // Actualizar √∫ltima query ejecutada
                    updateLastQuery(queryType, result.execution_time_ms, sql);
                } else {
                    updateStatus('Error en la consulta', 'error');
                }
            } catch (error) {
                showMessage('error', '‚ùå Error de conexi√≥n', error.message);
                updateStatus('Error de conexi√≥n', 'error');
            } finally {
                setExecuting(false);
            }
        }

        function displayResults(result) {
            const resultsContent = document.getElementById('resultsContent');
            const resultsInfo = document.getElementById('resultsInfo');
            const executionTime = document.getElementById('executionTime');

            // Mostrar tiempo con color seg√∫n performance
            const timeMs = result.execution_time_ms.toFixed(2);
            let timeColor = 'var(--accent-green)';
            let perfEmoji = '‚ö°';

            if (result.execution_time_ms > 100) {
                timeColor = 'var(--accent-orange)';
                perfEmoji = 'üêå';
            } else if (result.execution_time_ms > 50) {
                timeColor = 'var(--accent-yellow)';
                perfEmoji = '‚è±Ô∏è';
            }

            executionTime.innerHTML = `<span style="color: ${timeColor}">${perfEmoji} ${timeMs}ms</span>`;

            // Mostrar n√∫mero de queries ejecutadas si hay m√∫ltiples
            if (result.queries_executed && result.queries_executed > 1) {
                resultsInfo.textContent = ` - ${result.queries_executed} queries ejecutadas`;
            }

            if (result.success) {
                const data = result.result;

                // Si hay m√∫ltiples queries, mostrar resumen
                if (result.all_results && result.all_results.length > 1) {
                    resultsContent.innerHTML = `
                        <div class="multi-query-results">
                            <div class="message success">
                                <div class="message-icon">‚úÖ</div>
                                <div class="message-content">
                                    <strong>M√∫ltiples queries ejecutadas exitosamente</strong>
                                    <div style="margin-top: 10px;">
                                        ${result.all_results.map((r, i) => `
                                            <div style="margin: 5px 0; padding: 5px; background: rgba(0,122,204,0.1); border-radius: 3px;">
                                                <strong>${i + 1}.</strong> ${r.query}
                                                ${r.success ? '‚úÖ' : '‚ùå'}
                                                ${r.errors.length > 0 ? `<br><span style="color: var(--error-color);">${r.errors.join(', ')}</span>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            ${data && Array.isArray(data) && data.length > 0 ? `
                                <div style="margin-top: 20px;">
                                    <strong>üìä Resultado final (SELECT):</strong>
                                    <table class="data-table" style="margin-top: 10px;">
                                        <thead>
                                            <tr>${Object.keys(data[0]).map(key => `<th>${key}</th>`).join('')}</tr>
                                        </thead>
                                        <tbody>
                                            ${data.map(row => `
                                                <tr>${Object.keys(data[0]).map(key => `<td>${formatValue(row[key])}</td>`).join('')}</tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    if (!resultsInfo.textContent.includes('queries')) {
                        resultsInfo.textContent = ` - ${result.all_results.length} queries, ${data ? data.length + ' fila(s)' : 'sin resultados'}`;
                    }
                    return;
                }

                if (Array.isArray(data) && data.length > 0) {
                    // Display as table
                    resultsInfo.textContent = ` - ${data.length} fila(s)`;

                    const keys = Object.keys(data[0]);
                    resultsContent.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>${keys.map(key => `<th>${key}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${data.map(row => `
                                    <tr>${keys.map(key => `<td>${formatValue(row[key])}</td>`).join('')}</tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    // Display success message
                    resultsInfo.textContent = '';
                    resultsContent.innerHTML = `
                        <div class="message success">
                            <div class="message-icon">‚úÖ</div>
                            <div class="message-content">
                                <strong>√âxito</strong>
                                <div>${JSON.stringify(data, null, 2) || 'Operaci√≥n completada exitosamente'}</div>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Display errors con sugerencias
                resultsInfo.textContent = ` - ${result.errors.length} error(es)`;

                // Analizar errores y proporcionar ayuda
                const errorAnalysis = analyzeErrors(result.errors);

                resultsContent.innerHTML = `
                    <div class="message error">
                        <div class="message-icon">‚ùå</div>
                        <div class="message-content">
                            <strong>Error en la consulta</strong>
                            <div style="margin: 10px 0;">
                                ${result.errors.map(err => `<div style="margin: 5px 0;">‚Ä¢ ${escapeHtml(err)}</div>`).join('')}
                            </div>
                            ${errorAnalysis ? `
                                <div style="margin-top: 15px; padding: 10px; background: rgba(0, 122, 204, 0.1); border-left: 3px solid var(--accent-blue); border-radius: 3px;">
                                    <strong>üí° Sugerencia:</strong><br>
                                    ${errorAnalysis}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function analyzeErrors(errors) {
            const errorText = errors.join(' ').toLowerCase();

            // Errores comunes y sus soluciones
            if (errorText.includes('tabla') && errorText.includes('no existe')) {
                return 'La tabla no existe. Usa <code>CREATE TABLE</code> primero o verifica el nombre de la tabla.';
            }

            if (errorText.includes('se esperaba') && errorText.includes('punto y coma')) {
                return 'Falta el punto y coma (;) al final de la consulta SQL.';
            }

            if (errorText.includes('se esperaba') && errorText.includes('key')) {
                return 'Debes especificar una columna como KEY en la definici√≥n de la tabla. Ejemplo: <code>id INT KEY</code>';
            }

            if (errorText.includes('sintaxis') || errorText.includes('se esperaba')) {
                return 'Revisa la sintaxis de tu consulta SQL. Aseg√∫rate de que los par√©ntesis, comas y palabras clave est√©n correctamente ubicados.';
            }

            if (errorText.includes('duplicado') || errorText.includes('ya existe')) {
                return 'El registro con esa clave primaria ya existe. Las claves primarias deben ser √∫nicas.';
            }

            if (errorText.includes('archivo') && errorText.includes('no encontrado')) {
                return 'El archivo CSV especificado no existe. Verifica la ruta del archivo.';
            }

            if (errorText.includes('validaci√≥n')) {
                return 'Hay un problema con los tipos de datos. Verifica que los valores coincidan con los tipos de columna definidos.';
            }

            return null;  // No hay sugerencia espec√≠fica
        }

        function formatValue(value) {
            if (value === null || value === undefined) return '<em style="color: var(--text-secondary);">NULL</em>';
            if (typeof value === 'object') return JSON.stringify(value);
            return String(value);
        }

        async function viewTableData() {
            if (!state.currentTable) return;

            updateStatus(`Cargando datos de ${state.currentTable}...`, 'info');

            try {
                const response = await fetch(`${state.API_BASE}/table-data/${state.currentTable}?limit=100`);
                const result = await response.json();

                if (result.success && result.data) {
                    displayResults({
                        success: true,
                        result: result.data,
                        execution_time_ms: 0
                    });
                    updateStatus(`${result.count} fila(s) cargadas${result.truncated ? ' (truncado)' : ''}`, 'success');
                }
            } catch (error) {
                showMessage('error', '‚ùå Error', error.message);
            }
        }

        async function viewTableSchema() {
            if (!state.currentTable) return;

            try {
                const response = await fetch(`${state.API_BASE}/tables/${state.currentTable}`);
                const tableInfo = await response.json();

                const resultsContent = document.getElementById('resultsContent');
                const resultsInfo = document.getElementById('resultsInfo');
                const executionTime = document.getElementById('executionTime');

                resultsInfo.textContent = ` - ${tableInfo.columns.length} columna(s)`;
                executionTime.textContent = 'üìê Estructura';

                resultsContent.innerHTML = `
                    <div class="schema-table">
                        <div class="schema-header">
                            <span>üìã</span>
                            <strong>${tableInfo.name}</strong>
                        </div>
                        <div class="schema-body">
                            ${tableInfo.columns.map(col => `
                                <div class="schema-column">
                                    <span class="column-icon">${col.is_key ? 'üîë' : 'üìÑ'}</span>
                                    <span class="column-name">${col.name}</span>
                                    <span class="column-type">${col.type}${col.size ? `[${col.size}]` : ''}</span>
                                    ${col.index ? `<span class="badge primary column-badge">${col.index}</span>` : ''}
                                    ${col.is_key ? '<span class="badge column-badge">KEY</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                showMessage('error', '‚ùå Error', error.message);
            }
        }

        function generateSelect() {
            if (!state.currentTable) return;
            const sql = `SELECT * FROM ${state.currentTable};`;
            document.getElementById('sqlTextarea').value = sql;
            updateStatus(`SELECT generado para ${state.currentTable}`, 'success');
        }

        function generateInsert() {
            if (!state.currentTable) return;
            const sql = `INSERT INTO ${state.currentTable} VALUES ();`;
            document.getElementById('sqlTextarea').value = sql;
            updateStatus(`INSERT generado para ${state.currentTable}`, 'success');
        }

        function dropTable() {
            if (!state.currentTable) return;
            if (confirm(`¬øEst√°s seguro de que deseas eliminar la tabla "${state.currentTable}"?`)) {
                const sql = `DROP TABLE ${state.currentTable};`;
                document.getElementById('sqlTextarea').value = sql;
                executeQuery();
            }
        }

        function clearEditor() {
            document.getElementById('sqlTextarea').value = '';
            document.getElementById('resultsContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <div class="empty-state-text">Ejecuta una consulta para ver los resultados</div>
                </div>
            `;
            document.getElementById('resultsInfo').textContent = '';
            document.getElementById('executionTime').textContent = '';
            updateStatus('Editor limpiado', 'success');
        }

        async function formatSQL() {
            const textarea = document.getElementById('sqlTextarea');
            let sql = textarea.value.trim();

            if (!sql) {
                showMessage('warning', '‚ö†Ô∏è Advertencia', 'No hay SQL para formatear');
                return;
            }

            try {
                // Separar por punto y coma para procesar m√∫ltiples queries
                const statements = sql.split(';').filter(s => s.trim());
                let formattedStatements = [];

                for (let statement of statements) {
                    let formatted = statement.trim();

                    // 1. Convertir keywords a may√∫sculas
                    SQL_KEYWORDS.forEach(keyword => {
                        const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
                        formatted = formatted.replace(regex, keyword.toUpperCase());
                    });

                    // 2. Normalizar espacios m√∫ltiples (excepto en strings)
                    formatted = formatted.replace(/\s+/g, ' ');

                    // 3. Agregar saltos de l√≠nea despu√©s de keywords principales
                    formatted = formatted.replace(/\s+(FROM|WHERE|VALUES|SET|ORDER BY|GROUP BY)\s+/gi, '\n    $1 ');
                    formatted = formatted.replace(/\s+(AND|OR)\s+/gi, '\n        $1 ');

                    // 4. Formatear CREATE TABLE especialmente
                    if (formatted.toUpperCase().includes('CREATE TABLE')) {
                        formatted = formatted.replace(/\(\s*/g, ' (\n    ');
                        formatted = formatted.replace(/,\s*/g, ',\n    ');
                        formatted = formatted.replace(/\s*\)/g, '\n)');
                    }

                    // 5. Formatear INSERT VALUES
                    if (formatted.toUpperCase().includes('INSERT INTO')) {
                        formatted = formatted.replace(/VALUES\s*\(/gi, 'VALUES (');
                    }

                    // 6. Agregar espacios despu√©s de comas (excepto dentro de par√©ntesis de VALUES)
                    if (!formatted.toUpperCase().includes('VALUES')) {
                        formatted = formatted.replace(/,(?!\s)/g, ', ');
                    }

                    formattedStatements.push(formatted);
                }

                // 7. Unir todas las statements con punto y coma y doble salto de l√≠nea
                let finalFormatted = formattedStatements.join(';\n\n') + ';';

                textarea.value = finalFormatted;

                updateStatus('‚ú® SQL formateado correctamente', 'success');

                // Mostrar info sobre el formateo
                showMessage('success', '‚úÖ SQL Formateado',
                    `Se formatearon ${formattedStatements.length} consulta(s). Keywords en may√∫sculas, indentaci√≥n aplicada y estructura mejorada.`);

            } catch (error) {
                console.error('Error formateando SQL:', error);
                showMessage('error', '‚ùå Error al formatear',
                    'Hubo un problema formateando el SQL. Verifica la sintaxis b√°sica.');
            }
        }

        async function validateSQLInline(sql) {
            try {
                const response = await fetch(`${state.API_BASE}/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql, should_validate: true })
                });

                const result = await response.json();

                if (!result.valid) {
                    // Mostrar errores de validaci√≥n sin bloquear
                    const errorSummary = result.errors.slice(0, 3).join('\n‚Ä¢ ');
                    showMessage('warning', '‚ö†Ô∏è Advertencia de Validaci√≥n',
                        `Se detectaron posibles problemas:\n‚Ä¢ ${errorSummary}`);
                }
            } catch (error) {
                console.log('Error validando:', error);
            }
        }

        async function refreshTables() {
            updateStatus('Actualizando lista de tablas...', 'info');
            await loadTables();
            updateStatus('Lista de tablas actualizada', 'success');
        }

        function setExecuting(executing) {
            state.isExecuting = executing;
            const btn = document.getElementById('executeBtn');

            if (executing) {
                btn.innerHTML = '<span class="spinner"></span><span>Ejecutando...</span>';
                btn.disabled = true;
            } else {
                btn.innerHTML = '<span>‚ñ∂Ô∏è</span><span>Ejecutar</span>';
                btn.disabled = false;
            }
        }

        function updateStatus(message, type = 'info') {
            document.getElementById('statusMessage').textContent = message;
        }

        function showMessage(type, title, message) {
            const resultsContent = document.getElementById('resultsContent');
            const icon = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            }[type] || '‚ÑπÔ∏è';

            resultsContent.innerHTML = `
                <div class="message ${type}">
                    <div class="message-icon">${icon}</div>
                    <div class="message-content">
                        <strong>${title}</strong>
                        <div>${message}</div>
                    </div>
                </div>
            `;
        }

        // ===== WORKFLOW PIPELINE SYSTEM =====

        // Estado del workflow
        const workflow = {
            currentStep: 0,
            totalSteps: 10,
            completed: []
        };

        // √öltima query ejecutada
        let lastQuery = null;

        function updateLastQuery(queryType, timeMs, sql) {
            const timestamp = new Date().toLocaleTimeString('es-PE', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            lastQuery = {
                type: queryType,
                time: timeMs,
                timestamp: timestamp,
                sql: sql.substring(0, 60) + (sql.length > 60 ? '...' : '')
            };

            // Mostrar panel
            document.getElementById('perfStats').style.display = 'block';

            // Determinar color seg√∫n tiempo
            const timeColor = timeMs < 10 ? 'var(--accent-green)' :
                             timeMs < 50 ? 'var(--accent-yellow)' :
                             'var(--accent-red)';

            const perfIcon = timeMs < 10 ? '‚ö°' : timeMs < 50 ? '‚è±Ô∏è' : 'üêå';

            // Actualizar UI
            const lastQueryInfo = document.getElementById('lastQueryInfo');
            lastQueryInfo.innerHTML = `
                <div class="perf-stat-item">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                            <span class="perf-badge">${lastQuery.type}</span>
                            <span style="font-size: 10px; color: var(--text-secondary);">${lastQuery.timestamp}</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); font-family: monospace; margin-bottom: 8px;">
                            ${lastQuery.sql}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                        <div style="font-weight: 700; font-size: 18px; color: ${timeColor};">
                            ${perfIcon} ${timeMs.toFixed(2)}ms
                        </div>
                        <div style="font-size: 10px; color: var(--text-secondary);">
                            Tiempo de ejecuci√≥n
                        </div>
                    </div>
                </div>
            `;
        }

        // Consultas SQL para cada paso - Pipeline completo con diferentes estructuras
        const workflowQueries = {
            1: `-- PASO 1: CREATE TABLE con Sequential File (INDEX SEQ)
CREATE TABLE Empleados (
    id INT KEY INDEX SEQ,
    nombre VARCHAR[100],
    departamento VARCHAR[50],
    salario FLOAT,
    fecha_ingreso VARCHAR[20],
    nivel INT
);`,
            2: `-- PASO 2: INSERT masivo - 15 registros en Sequential
INSERT INTO Empleados VALUES (101, "Ana Garc√≠a Mart√≠nez", "Desarrollo", 4500.50, "2020-01-15", 3);
INSERT INTO Empleados VALUES (102, "Carlos L√≥pez Ruiz", "Marketing", 3800.00, "2019-05-20", 2);
INSERT INTO Empleados VALUES (103, "Mar√≠a P√©rez Santos", "Ventas", 4200.75, "2021-03-10", 3);
INSERT INTO Empleados VALUES (104, "Juan Rodr√≠guez D√≠az", "Desarrollo", 5500.00, "2018-11-05", 4);
INSERT INTO Empleados VALUES (105, "Laura Fern√°ndez Gil", "RRHH", 3600.25, "2022-01-08", 2);
INSERT INTO Empleados VALUES (106, "Pedro S√°nchez Torres", "Finanzas", 4800.00, "2019-08-12", 3);
INSERT INTO Empleados VALUES (107, "Sof√≠a Ram√≠rez Cruz", "Desarrollo", 5200.50, "2020-06-18", 4);
INSERT INTO Empleados VALUES (108, "Diego Morales Vega", "Marketing", 3900.00, "2021-09-22", 2);
INSERT INTO Empleados VALUES (109, "Elena Castro Flores", "Ventas", 4100.00, "2020-12-03", 3);
INSERT INTO Empleados VALUES (110, "Miguel Ortiz Reyes", "TI", 5800.75, "2017-04-14", 5);
INSERT INTO Empleados VALUES (111, "Carmen Jim√©nez Luna", "RRHH", 3700.00, "2022-07-25", 2);
INSERT INTO Empleados VALUES (112, "Roberto Vargas Paz", "Desarrollo", 4900.50, "2019-10-30", 3);
INSERT INTO Empleados VALUES (113, "Isabel Romero Silva", "Finanzas", 5100.25, "2018-02-17", 4);
INSERT INTO Empleados VALUES (114, "Francisco Ruiz Campos", "Marketing", 4000.00, "2021-11-11", 2);
INSERT INTO Empleados VALUES (115, "Patricia Herrera Ramos", "Ventas", 4300.75, "2020-08-07", 3);`,
            3: `-- PASO 3: SELECT con BETWEEN (b√∫squeda de rango en Sequential)
SELECT * FROM Empleados WHERE id BETWEEN 105 AND 110;`,
            4: `-- PASO 4: CREATE TABLE con B+Tree (INDEX BTree)
CREATE TABLE Productos (
    codigo INT KEY INDEX BTree,
    nombre VARCHAR[100],
    categoria VARCHAR[50],
    precio FLOAT,
    stock INT,
    proveedor VARCHAR[100]
);`,
            5: `-- PASO 5: INSERT en B+Tree - 15 productos
INSERT INTO Productos VALUES (1001, "Laptop Dell XPS 15", "Electr√≥nica", 1299.99, 25, "Dell Inc");
INSERT INTO Productos VALUES (1002, "Mouse Logitech MX Master", "Accesorios", 99.99, 150, "Logitech");
INSERT INTO Productos VALUES (1003, "Teclado Mec√°nico Razer", "Accesorios", 149.99, 80, "Razer");
INSERT INTO Productos VALUES (1004, "Monitor Samsung 27 4K", "Electr√≥nica", 399.99, 45, "Samsung");
INSERT INTO Productos VALUES (1005, "Disco SSD 1TB NVMe", "Almacenamiento", 129.99, 200, "Kingston");
INSERT INTO Productos VALUES (1006, "Memoria RAM 16GB DDR4", "Componentes", 79.99, 120, "Corsair");
INSERT INTO Productos VALUES (1007, "Tarjeta Gr√°fica RTX 3060", "Componentes", 399.99, 30, "NVIDIA");
INSERT INTO Productos VALUES (1008, "Procesador Intel i7", "Componentes", 349.99, 50, "Intel");
INSERT INTO Productos VALUES (1009, "Motherboard ASUS ROG", "Componentes", 249.99, 40, "ASUS");
INSERT INTO Productos VALUES (1010, "Fuente 750W Modular", "Componentes", 119.99, 60, "EVGA");
INSERT INTO Productos VALUES (1011, "Gabinete NZXT H510", "Componentes", 89.99, 35, "NZXT");
INSERT INTO Productos VALUES (1012, "Webcam Logitech C920", "Accesorios", 79.99, 90, "Logitech");
INSERT INTO Productos VALUES (1013, "Micr√≥fono Blue Yeti", "Audio", 129.99, 55, "Blue");
INSERT INTO Productos VALUES (1014, "Aud√≠fonos Sony WH-1000XM4", "Audio", 349.99, 70, "Sony");
INSERT INTO Productos VALUES (1015, "Router WiFi 6 TP-Link", "Redes", 199.99, 85, "TP-Link");`,
            6: `-- PASO 6: SELECT exacto en B+Tree (O(log n))
SELECT * FROM Productos WHERE codigo = 1007;`,
            7: `-- PASO 7: CREATE TABLE con Extendible Hash (INDEX Hash)
CREATE TABLE Clientes (
    dni INT KEY INDEX Hash,
    nombre VARCHAR[100],
    email VARCHAR[100],
    telefono VARCHAR[20],
    ciudad VARCHAR[50],
    credito FLOAT
);`,
            8: `-- PASO 8: INSERT en Hash - 10 clientes
INSERT INTO Clientes VALUES (12345678, "Roberto S√°nchez", "roberto.s@email.com", "+51-987654321", "Lima", 5000.00);
INSERT INTO Clientes VALUES (23456789, "Luc√≠a Morales", "lucia.m@email.com", "+51-912345678", "Arequipa", 3500.50);
INSERT INTO Clientes VALUES (34567890, "Fernando Torres", "fernando.t@email.com", "+51-923456789", "Cusco", 4200.75);
INSERT INTO Clientes VALUES (45678901, "Gabriela Reyes", "gabriela.r@email.com", "+51-934567890", "Trujillo", 6800.00);
INSERT INTO Clientes VALUES (56789012, "Andr√©s Castro", "andres.c@email.com", "+51-945678901", "Lima", 2900.25);
INSERT INTO Clientes VALUES (67890123, "Valentina Ruiz", "valentina.r@email.com", "+51-956789012", "Chiclayo", 5500.00);
INSERT INTO Clientes VALUES (78901234, "Sebasti√°n Flores", "sebastian.f@email.com", "+51-967890123", "Piura", 4100.50);
INSERT INTO Clientes VALUES (89012345, "Camila Vargas", "camila.v@email.com", "+51-978901234", "Lima", 7200.00);
INSERT INTO Clientes VALUES (90123456, "Mateo Silva", "mateo.s@email.com", "+51-989012345", "Iquitos", 3800.75);
INSERT INTO Clientes VALUES (11223344, "Isabella Ramos", "isabella.r@email.com", "+51-990123456", "Tacna", 4500.00);`,
            9: `-- PASO 9: SELECT exacto en Hash (O(1))
SELECT * FROM Clientes WHERE dni = 45678901;`,
            10: `-- PASO 10: Queries complejas con condiciones m√∫ltiples
SELECT * FROM Empleados WHERE salario > 4500;
DELETE FROM Empleados WHERE id = 102;
SELECT * FROM Productos WHERE precio < 150 AND stock > 50;`
        };

        function toggleQuickActions() {
            const content = document.getElementById('quickActionsContent');
            const toggle = document.getElementById('quickActionsToggle');

            content.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
        }

        function updateWorkflowProgress() {
            const percent = Math.round((workflow.completed.length / workflow.totalSteps) * 100);
            document.getElementById('workflowPercent').textContent = percent;
            document.getElementById('progressFill').style.width = percent + '%';

            // Actualizar estados visuales
            for (let i = 1; i <= workflow.totalSteps; i++) {
                const stepElement = document.getElementById(`step${i}`);
                stepElement.classList.remove('completed', 'active');

                if (workflow.completed.includes(i)) {
                    stepElement.classList.add('completed');
                }
                if (workflow.currentStep === i) {
                    stepElement.classList.add('active');
                }
            }
        }

        async function runWorkflowStep(step) {
            // Expandir el panel si est√° colapsado
            const content = document.getElementById('quickActionsContent');
            const toggle = document.getElementById('quickActionsToggle');
            if (!content.classList.contains('expanded')) {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }

            workflow.currentStep = step;
            updateWorkflowProgress();

            // Cargar la consulta en el editor
            const textarea = document.getElementById('sqlTextarea');
            textarea.value = workflowQueries[step];

            // Scroll al inicio del editor
            textarea.scrollTop = 0;

            // Mostrar mensaje en status
            const stepNames = {
                1: 'Sequential - Crear Tabla',
                2: 'Sequential - Insertar 15 Registros',
                3: 'Sequential - B√∫squeda Rango',
                4: 'B+Tree - Crear Tabla',
                5: 'B+Tree - Insertar 15 Productos',
                6: 'B+Tree - B√∫squeda Exacta',
                7: 'Hash - Crear Tabla',
                8: 'Hash - Insertar 10 Clientes',
                9: 'Hash - B√∫squeda O(1)',
                10: 'Multi-Query - An√°lisis Final'
            };

            updateStatus(`üöÄ Pipeline - Paso ${step}/10: ${stepNames[step]}`, 'info');

            // Mostrar instrucciones en el panel de resultados
            showWorkflowInstructions(step);

            // Si es el paso 2, esperar un poco y ejecutar autom√°ticamente cada INSERT
            if (step === 2) {
                setTimeout(() => {
                    showMessage('info', 'üí° Tip',
                        'Para el Paso 2, puedes ejecutar todos los INSERT a la vez presionando Ctrl+Enter, o ejecutarlos uno por uno.');
                }, 500);
            }
        }

        function showWorkflowInstructions(step) {
            const resultsContent = document.getElementById('resultsContent');
            const instructions = {
                1: {
                    icon: 'üìù',
                    title: 'Paso 1/10: CREATE TABLE - Sequential',
                    text: 'Tabla "Empleados" con √≠ndice SEQ. Estructura ordenada para b√∫squedas por rango.',
                    action: 'Ejecuta y observa el tiempo de ejecuci√≥n.',
                    tech: 'Sequential File | O(log n)'
                },
                2: {
                    icon: '‚ûï',
                    title: 'Paso 2/10: Inserci√≥n Masiva en Sequential',
                    text: 'Insertaremos <strong>15 empleados</strong> con datos completos (nombre, departamento, salario, fecha, nivel). El Sequential File mantiene los registros ordenados por ID autom√°ticamente para b√∫squedas eficientes.',
                    action: 'Ejecuta para insertar los 15 registros. Observa el tiempo de inserci√≥n.',
                    tech: '‚öôÔ∏è 15 INSERTs | Mantenimiento de orden autom√°tico'
                },
                3: {
                    icon: 'üìä',
                    title: 'Paso 3/10: B√∫squeda por Rango (BETWEEN)',
                    text: 'Consulta de rango en Sequential File: <code>WHERE id BETWEEN 105 AND 110</code>. Esta es la fortaleza del Sequential - b√∫squedas de rango muy eficientes gracias al orden mantenido.',
                    action: 'Ejecuta el SELECT con BETWEEN y observa la rapidez de la consulta de rango.',
                    tech: '‚öôÔ∏è Range Query | Aprovecha el orden secuencial'
                },
                4: {
                    icon: 'üå≥',
                    title: 'Paso 4/10: Crear Tabla con B+Tree',
                    text: 'Ahora usaremos <strong>B+Tree</strong> para la tabla "Productos". Los B+Trees son perfectos para b√∫squedas exactas r√°pidas y mantienen los datos ordenados con O(log n). Mejor que Sequential para b√∫squedas individuales frecuentes.',
                    action: 'Crea la tabla Productos con √≠ndice B+Tree de orden 4.',
                    tech: '‚öôÔ∏è Estructura: B+Tree | B√∫squeda: O(log n) | Balanceado'
                },
                5: {
                    icon: 'ÔøΩ',
                    title: 'Paso 5/10: Carga de Productos en B+Tree',
                    text: 'Insertamos <strong>15 productos</strong> (laptops, componentes, accesorios) en el B+Tree. El √°rbol se auto-balancea durante la inserci√≥n, garantizando b√∫squedas logar√≠tmicas siempre. Incluye c√≥digo, nombre, categor√≠a, precio, stock y proveedor.',
                    action: 'Ejecuta para insertar productos y observar el auto-balanceo del √°rbol.',
                    tech: '‚öôÔ∏è 15 INSERTs | Auto-balanceo | Nodos ordenados'
                },
                6: {
                    icon: 'üéØ',
                    title: 'Paso 6/10: B√∫squeda Exacta en B+Tree',
                    text: 'B√∫squeda directa por c√≥digo: <code>WHERE codigo = 1007</code>. El B+Tree navega desde la ra√≠z hasta la hoja en tiempo logar√≠tmico, muy eficiente para b√∫squedas exactas. Compara el tiempo con Sequential.',
                    action: 'Ejecuta el SELECT exacto y observa el tiempo de ejecuci√≥n en ms.',
                    tech: '‚öôÔ∏è Exact Match | O(log n) garantizado | Sin scans'
                },
                7: {
                    icon: '#Ô∏è‚É£',
                    title: 'Paso 7/10: Crear Tabla con Extendible Hashing',
                    text: 'Tabla "Clientes" con <strong>Extendible Hashing</strong> - la estructura m√°s r√°pida para b√∫squedas exactas por clave. Tiempo constante O(1) usando funci√≥n hash. Ideal cuando no necesitas orden ni rangos.',
                    action: 'Crea la tabla con √≠ndice Hash para acceso instant√°neo.',
                    tech: '‚öôÔ∏è Estructura: Hash | B√∫squeda: O(1) | Global depth'
                },
                8: {
                    icon: 'ÔøΩ',
                    title: 'Paso 8/10: Registro de Clientes con Hash',
                    text: 'Insertamos <strong>10 clientes</strong> con DNI como clave. El hash distribuye los registros en buckets usando una funci√≥n hash del DNI. Observa c√≥mo puede ser m√°s r√°pido que B+Tree para inserciones simples.',
                    action: 'Ejecuta para insertar clientes v√≠a hashing. Nota el tiempo.',
                    tech: '‚öôÔ∏è 10 INSERTs | Distribuci√≥n por hash(DNI) | Buckets'
                },
                9: {
                    icon: '‚ö°',
                    title: 'Paso 9/10: B√∫squeda Hash O(1) - Instant√°nea',
                    text: 'B√∫squeda ultra r√°pida: <code>WHERE dni = 45678901</code>. El hash calcula la posici√≥n directamente - NO necesita recorrer nada. Este es el tiempo de acceso m√°s r√°pido posible. Compara con B+Tree y Sequential.',
                    action: 'Ejecuta y observa el tiempo en ms - deber√≠a ser el m√°s r√°pido.',
                    tech: '‚öôÔ∏è Direct Access | O(1) tiempo constante | 1 lectura'
                },
                10: {
                    icon: 'üéØ',
                    title: 'Paso 10/10: An√°lisis Multi-Query Final',
                    text: 'Consultas complejas combinadas: SELECT con condiciones m√∫ltiples, DELETE y verificaci√≥n. Observa c√≥mo cada estructura maneja diferentes tipos de queries. Compara tiempos totales de las 3 estructuras usadas.',
                    action: 'Ejecuta el conjunto final de queries anal√≠ticas.',
                    tech: '‚öôÔ∏è Multi-query | WHERE compuesto | DELETE + SELECT'
                }
            };

            const instr = instructions[step];
            resultsContent.innerHTML = `
                <div class="message info">
                    <div class="message-icon" style="font-size: 32px;">${instr.icon}</div>
                    <div class="message-content">
                        <strong>${instr.title}</strong>
                        <div style="margin: 12px 0; line-height: 1.6;">
                            ${instr.text}
                        </div>
                        <div style="padding: 8px 12px; background: rgba(78, 201, 176, 0.1); border-left: 3px solid var(--accent-green); border-radius: 4px; font-size: 12px; margin: 10px 0;">
                            ${instr.tech}
                        </div>
                        <div style="padding: 8px 12px; background: rgba(0, 122, 204, 0.1); border-radius: 4px; font-size: 12px;">
                            <strong>üëâ Acci√≥n:</strong> ${instr.action}
                        </div>
                    </div>
                </div>
            `;
        }

        // Interceptar ejecuci√≥n exitosa para marcar pasos como completados
        const originalExecuteQuery = executeQuery;
        executeQuery = async function() {
            await originalExecuteQuery();

            // Si estamos en modo workflow, marcar como completado despu√©s de ejecutar
            if (workflow.currentStep > 0 && workflow.currentStep <= workflow.totalSteps) {
                setTimeout(() => {
                    const lastResult = document.getElementById('resultsContent');
                    if (lastResult && !lastResult.innerHTML.includes('error')) {
                        if (!workflow.completed.includes(workflow.currentStep)) {
                            workflow.completed.push(workflow.currentStep);
                            updateWorkflowProgress();

                            // Si completamos todos los pasos
                            if (workflow.completed.length === workflow.totalSteps) {
                                setTimeout(() => {
                                    showMessage('success', 'üéâ Pipeline Completado',
                                        `Demostraci√≥n completada exitosamente:<br><br>
                                        ‚úÖ Sequential File (15 registros)<br>
                                        ‚úÖ B+Tree (15 registros)<br>
                                        ‚úÖ Extendible Hash (10 registros)<br><br>
                                        Revisa el historial de ejecuci√≥n para comparar tiempos.`);
                                    updateStatus('Pipeline completado', 'success');
                                }, 1000);
                            } else {
                                // Sugerir el siguiente paso
                                const nextStep = workflow.currentStep + 1;
                                if (nextStep <= workflow.totalSteps) {
                                    setTimeout(() => {
                                        const stepElement = document.getElementById(`step${nextStep}`);
                                        stepElement.style.animation = 'pulse 1s ease-in-out 3';
                                        updateStatus(`‚úÖ Paso ${workflow.currentStep} completado. Contin√∫a con el Paso ${nextStep}`, 'success');
                                    }, 1500);
                                }
                            }
                        }
                    }
                }, 500);
            }
        };

        // Auto-refresh server status every 30 seconds
        setInterval(async () => {
            await checkServerStatus();
        }, 30000);
    </script>
</body>
</html>
